import { IDocumentTemplate } from '@interfaces';

/**
 * Маппинг стадий процесса
 */
const STAGE_NAMES: Record<number, string> = {
  1: 'Возбуждение дела',
  2: 'Подготовка дела',
  3: 'Судебное разбирательство',
  4: 'После решения',
  5: 'Обжалование',
  6: 'Исполнение',
  7: 'Разбирательство',
  8: 'Решение',
};

/**
 * RAG-стратегии по стадиям процесса
 */
interface RAGStrategy {
  kz_gk: { queries: number; focus: string };
  kz_gpk: { queries: number; focus: string };
  kz_civil_practice: { queries: number; focus: string };
}

const STAGE_RAG_STRATEGIES: Record<number, RAGStrategy> = {
  // Возбуждение дела - акцент на форму иска и материальные основания
  1: {
    kz_gk: {
      queries: 2,
      focus: 'материальные основания требований, права и обязанности сторон',
    },
    kz_gpk: {
      queries: 2,
      focus:
        'форма и содержание искового заявления, подсудность, госпошлина, приложения',
    },
    kz_civil_practice: {
      queries: 1,
      focus: 'структура обоснования требований',
    },
  },
  // Подготовка дела - акцент на процедуры и доказательства
  2: {
    kz_gk: { queries: 1, focus: 'факты и обстоятельства дела' },
    kz_gpk: {
      queries: 2,
      focus:
        'подготовка дела к разбирательству, истребование доказательств, привлечение третьих лиц',
    },
    kz_civil_practice: { queries: 1, focus: 'стандарты доказывания' },
  },
  // Судебное разбирательство - акцент на доказательства и практику
  3: {
    kz_gk: { queries: 1, focus: 'применимые нормы материального права' },
    kz_gpk: {
      queries: 2,
      focus:
        'порядок судебного разбирательства, представление доказательств, ходатайства',
    },
    kz_civil_practice: {
      queries: 2,
      focus: 'оценка доказательств, процессуальная тактика',
    },
  },
  // После решения - акцент на исполнение и разъяснение
  4: {
    kz_gk: { queries: 1, focus: 'материальные последствия решения' },
    kz_gpk: {
      queries: 2,
      focus: 'разъяснение решения, исправление описок, дополнительное решение',
    },
    kz_civil_practice: { queries: 2, focus: 'практика исполнения решений' },
  },
  // Обжалование - акцент на апелляцию/кассацию
  5: {
    kz_gk: { queries: 1, focus: 'нарушения норм материального права' },
    kz_gpk: {
      queries: 2,
      focus:
        'апелляционное/кассационное производство, сроки, основания обжалования',
    },
    kz_civil_practice: {
      queries: 2,
      focus: 'основания отмены/изменения решений, судебная практика',
    },
  },
  // Исполнение - акцент на исполнительное производство
  6: {
    kz_gk: { queries: 1, focus: 'материальные права при исполнении' },
    kz_gpk: {
      queries: 2,
      focus: 'исполнительное производство, меры принудительного исполнения',
    },
    kz_civil_practice: {
      queries: 2,
      focus: 'практика исполнительного производства',
    },
  },
  // Разбирательство (дополнительная стадия)
  7: {
    kz_gk: { queries: 1, focus: 'применимые нормы' },
    kz_gpk: { queries: 2, focus: 'порядок разбирательства' },
    kz_civil_practice: { queries: 2, focus: 'судебная практика' },
  },
  // Решение (дополнительная стадия)
  8: {
    kz_gk: { queries: 1, focus: 'материально-правовое обоснование' },
    kz_gpk: { queries: 1, focus: 'требования к решению суда' },
    kz_civil_practice: { queries: 2, focus: 'структура и мотивировка решения' },
  },
};

/**
 * Инструкции по ролям
 */
const ROLE_INSTRUCTIONS: Record<number, string> = {
  1: `ТВОЯ РОЛЬ: Ты представляешь интересы ИСТЦА.
- Обосновывай требования истца с опорой на нормы права
- Формулируй позицию так, чтобы максимизировать шансы на удовлетворение иска
- Указывай на нарушения прав истца и необходимость их защиты`,

  2: `ТВОЯ РОЛЬ: Ты представляешь интересы ОТВЕТЧИКА.
- Формируй возражения и контраргументы против требований истца
- Указывай на слабые места в позиции истца
- Обосновывай отказ в удовлетворении требований или их уменьшение
- Ссылайся на обстоятельства, исключающие или смягчающие ответственность`,
};

/**
 * Инструкции по секциям документа
 */
const SECTION_INSTRUCTIONS: Record<string, string> = {
  header: `ШАПКА (реквизиты):
- Наименование суда и его адрес
- Данные сторон (ФИО/наименование, ИИН/БИН, адрес, контакты)
- Номер дела (если есть)
- Представитель (при наличии)`,

  standard_header: `ШАПКА (реквизиты):
- Наименование суда и его адрес
- Истец: ФИО, ИИН/БИН, адрес, контакты
- Ответчик: ФИО, ИИН/БИН, адрес, контакты
- Представитель (при наличии)`,

  standard_header_defendant: `ШАПКА (реквизиты):
- Наименование суда и его адрес
- Номер дела
- Ответчик: ФИО, ИИН/БИН, адрес, контакты
- Истец: ФИО, ИИН/БИН, адрес, контакты`,

  body: `ТЕКСТ ДОКУМЕНТА:
- Изложение обстоятельств дела
- Правовое обоснование со ссылками на нормы из RAG
- Логичная аргументация позиции`,

  standard_body: `ТЕКСТ ДОКУМЕНТА:
- Описательная часть: изложение фактических обстоятельств из ситуации
- Мотивировочная часть: правовое обоснование со ссылками на ГК РК и ГПК РК
- Используй нормы, найденные через RAG`,

  facts: `ФАКТИЧЕСКИЕ ОБСТОЯТЕЛЬСТВА:
- Изложи обстоятельства из описания ситуации
- Укажи хронологию событий
- Перечисли ключевые факты, имеющие значение для дела`,

  standard_facts: `ФАКТИЧЕСКИЕ ОБСТОЯТЕЛЬСТВА:
- Изложи обстоятельства из описания ситуации клиента
- Укажи даты, суммы, действия сторон
- Опиши, какие права были нарушены или какие обязательства не исполнены`,

  legal_basis: `ПРАВОВЫЕ ОСНОВАНИЯ:
- Ссылки на статьи ГК РК (материальное право) из результатов RAG
- Ссылки на статьи ГПК РК (процессуальное право) из результатов RAG
- Если номер статьи не найден — пиши <<НУЖНО УТОЧНИТЬ: статья>>`,

  standard_legal_basis: `ПРАВОВЫЕ ОСНОВАНИЯ:
- Материально-правовые основания из kz_gk
- Процессуальные основания из kz_gpk
- Формат: "В соответствии со ст. ХХХ ГК РК / ГПК РК..."`,

  requests: `ПРОСИТЕЛЬНАЯ ЧАСТЬ:
- Конкретные требования к суду
- Каждое требование на отдельной строке с нумерацией
- Требования должны соответствовать ситуации и нормам права`,

  standard_requests: `ПРОСИТЕЛЬНАЯ ЧАСТЬ:
На основании изложенного ПРОШУ СУД:
1) [конкретное требование, согласованное с ситуацией и нормами]
2) [дополнительное требование при необходимости]
- Требования должны быть исполнимыми и соответствовать закону`,

  attachments: `ПРИЛОЖЕНИЯ:
- Перечень прилагаемых документов
- Доказательства, подтверждающие обстоятельства
- Документ об оплате госпошлины (если требуется)
- Копии документов для сторон`,

  standard_attachments: `ПРИЛОЖЕНИЯ:
Перечень прилагаемых документов:
1) Копия документа для ответчика/истца
2) Документ об оплате госпошлины (если применимо)
3) Доказательства по ситуации
- Если доказательства не указаны в ситуации — пиши <<НУЖНО УТОЧНИТЬ: перечень доказательств>>`,

  signature: `ДАТА И ПОДПИСЬ:
- Дата в формате «DD» месяц прописью YYYY г.
- Подпись: ____________________`,

  standard_signature: `ДАТА И ПОДПИСЬ:
Дата: «___» __________ 20__ г.
Подпись: ____________________`,
};

/**
 * Специальные правила для определённых типов документов
 */
interface SpecialDocumentRules {
  requiresCourtDecision?: boolean; // Требует генерации предварительного решения
  requiresExpertQuestions?: boolean; // Требует вопросов для эксперта
  requiresBothParties?: boolean; // Требует согласия обеих сторон (мировое соглашение)
  appealType?: 'appellate' | 'cassation' | 'private'; // Тип обжалования
  executionType?: boolean; // Исполнительное производство
}

/**
 * Определение специальных правил по ID документа
 */
function getSpecialRules(
  documentId: number,
  documentName: string,
): SpecialDocumentRules {
  const rules: SpecialDocumentRules = {};

  // Исковые заявления требуют предварительного решения
  if (documentId <= 3 || documentName.includes('Исковое заявление')) {
    rules.requiresCourtDecision = true;
  }

  // Экспертиза требует вопросов
  if (documentName.includes('экспертиз')) {
    rules.requiresExpertQuestions = true;
  }

  // Мировое соглашение
  if (
    documentName.includes('Мировое соглашение') ||
    documentName.includes('мировое соглашение')
  ) {
    rules.requiresBothParties = true;
  }

  // Апелляционная жалоба
  if (documentName.includes('Апелляционная жалоба')) {
    rules.appealType = 'appellate';
  }

  // Кассационная жалоба
  if (documentName.includes('Кассационная жалоба')) {
    rules.appealType = 'cassation';
  }

  // Частная жалоба
  if (documentName.includes('Частная жалоба')) {
    rules.appealType = 'private';
  }

  // Исполнительное производство
  if (
    documentName.includes('исполнительн') ||
    documentName.includes('Исполнительн')
  ) {
    rules.executionType = true;
  }

  return rules;
}

/**
 * Генерация инструкций для специальных случаев
 */
function buildSpecialInstructions(rules: SpecialDocumentRules): string {
  const instructions: string[] = [];

  if (rules.requiresCourtDecision) {
    instructions.push(`
ДОПОЛНИТЕЛЬНО — ПРЕДВАРИТЕЛЬНОЕ РЕШЕНИЕ СУДА:
После основного документа сформируй БЛОК B: ПРЕДВАРИТЕЛЬНОЕ РЕШЕНИЕ СУДА
- Используй ТОЛЬКО коллекцию kz_civil_practice
- Включи: вводную часть, описательную часть, мотивировочную часть, резолютивную часть
- Оцени доказательства и сделай вывод по существу требований`);
  }

  if (rules.requiresExpertQuestions) {
    instructions.push(`
ВОПРОСЫ ДЛЯ ЭКСПЕРТА:
- Сформулируй конкретные вопросы для экспертизы
- Вопросы должны быть ясными и не требовать правовой оценки
- Укажи, какие материалы предоставить эксперту`);
  }

  if (rules.requiresBothParties) {
    instructions.push(`
ОСОБЕННОСТИ МИРОВОГО СОГЛАШЕНИЯ:
- Документ требует согласия ОБЕИХ сторон
- Укажи взаимные уступки и обязательства каждой стороны
- Определи сроки и порядок исполнения
- Включи последствия нарушения условий соглашения`);
  }

  if (rules.appealType === 'appellate') {
    instructions.push(`
ОСОБЕННОСТИ АПЕЛЛЯЦИОННОЙ ЖАЛОБЫ:
- Укажи решение суда первой инстанции, которое обжалуется
- Обоснуй нарушения норм материального или процессуального права
- Сформулируй, в чём выразилось неправильное определение обстоятельств
- Просительная часть: отменить/изменить решение, принять новое решение`);
  }

  if (rules.appealType === 'cassation') {
    instructions.push(`
ОСОБЕННОСТИ КАССАЦИОННОЙ ЖАЛОБЫ:
- Укажи решения судов первой и апелляционной инстанций
- Обоснуй существенные нарушения норм материального или процессуального права
- Кассация проверяет ТОЛЬКО правильность применения права, не факты
- Просительная часть: отменить судебные акты, направить на новое рассмотрение или принять новое решение`);
  }

  if (rules.appealType === 'private') {
    instructions.push(`
ОСОБЕННОСТИ ЧАСТНОЙ ЖАЛОБЫ:
- Обжалуется ОПРЕДЕЛЕНИЕ суда, а не решение
- Укажи, какое определение и по какому вопросу обжалуется
- Обоснуй незаконность или необоснованность определения`);
  }

  if (rules.executionType) {
    instructions.push(`
ОСОБЕННОСТИ ИСПОЛНИТЕЛЬНОГО ПРОИЗВОДСТВА:
- Укажи реквизиты исполнительного документа
- Ссылайся на нормы об исполнительном производстве
- При необходимости укажи конкретные меры принудительного исполнения`);
  }

  return instructions.join('\n');
}

/**
 * Основной сервис для генерации промптов
 */
export const PromptService = {
  /**
   * Получить базовый промпт (для обратной совместимости)
   */
  getMainPrompt() {
    return `
      Ты — юрист-практик по Республике Казахстан.

      ТВОЯ ЦЕЛЬ:
      Сформировать финальный судебный документ, который можно распечатать и подать в суд, строго по структуре ниже. Так же к документу нужно отдельно добавить предварительное решение суда.

      КРИТИЧЕСКОЕ ТРЕБОВАНИЕ (RAG):
      Используй ТОЛЬКО три коллекции в Qdrant и обязательно сделай поиск по каждой:
      1) ГК РК: collection="kz_gk" — материально-правовые основания (права/обязанности сторон, основания требований).
      2) ГПК РК: collection="kz_gpk" — процессуальные требования: форма/содержание, подсудность/сроки/пошлина (если применимо), перечень приложений.
      3) Судебное решение/практика: collection="kz_civil_practice" — принципы формирования решения: оценка доказательств, мотивировка, резолютивная часть.

      RAG-ПРОЦЕДУРА (ОБЯЗАТЕЛЬНО, НО БЕЗ ЛИШНИХ ВЫЗОВОВ):
      - Сделай поиски ТОЛЬКО через tool search_legislation (никаких иных источников).
      - Используй limit=5 (инструмент всё равно ограничивает большие значения).
      - Выполни ровно такие вызовы:
        A) kz_gk: 2 запроса (материальные основания именно под ситуацию/предмет иска)
        B) kz_gpk: 2 запроса (форма/содержание иска + приложения/доказательства/пошлина/подсудность — что релевантно)
        C) kz_civil_practice: 2 запроса (мотивировка/оценка доказательств + резолютивная часть/структура решения)
      - Если в ходе написания явно не хватает нормы — разрешён +1 дополнительный запрос в нужную коллекцию, но не больше.
      - Затем пиши документ, вставляя найденные нормы ровно в нужные места каркаса.

      КАК ПИСАТЬ:
      - Официально-деловой стиль.
      - Там, где нужны статьи/пункты — ссылайся на найденные фрагменты (достаточно "в соответствии со ст. …").
      - Не выдумывай нормы/номера статей.
      - Не добавляй "шаблон/пояснения". Верни ТОЛЬКО готовый документ.

      ПРАВИЛО ССЫЛОК:
      - Если в результате search_legislation указан номер статьи (например "Статья 152" в тексте или ", 152" рядом с источником),
        ссылайся так: "в соответствии со ст. <номер> ГК РК" или "… ГПК РК" (в зависимости от коллекции).
      - Если номера статьи нет — НЕ выдумывай: пиши <<НУЖНО УТОЧНИТЬ: статья>> и опирайся на смысл найденного фрагмента.
      - Если релевантные фрагменты не найдены: НЕ выдумывай нормы — ставь <<НУЖНО УТОЧНИТЬ: правовое основание / статья>>.
    `.trim();
  },

  /**
   * Получить промпт для первого шаблона (для обратной совместимости)
   */
  getFirstTemplatePrompt(general_prompt: string, template: string) {
    return `
      ${general_prompt}
      ФОРМАТ ВЫВОДА (ОБЯЗАТЕЛЬНО):
      - Верни ТОЛЬКО 2 блока текста в указанном порядке:
        БЛОК A: ИСКОВОЕ ЗАЯВЛЕНИЕ — строго по структуре ниже (заполни все прочерки).
        БЛОК B: ПРЕДВАРИТЕЛЬНОЕ РЕШЕНИЕ СУДА — отдельным разделом после иска.
      - Никаких пояснений, чеклистов, "как я думал", ссылок на промпт/коллекции.
      - Не используй Markdown.

      ЖЁСТКОЕ ПРАВИЛО ЗАПОЛНЕНИЯ:
      - В финальном тексте не должно остаться строк вида "_____", "__________", "__" (кроме строки "Подпись").
      - Любой прочерк замени на содержательный текст. Если данных не хватает — пиши <<НУЖНО УТОЧНИТЬ: ...>>.

      Прочерки, которые нужно заменить на содержательный текст:
      1) В соответствии со ст. ... → "материальные основания из kz_gk + процессуальные требования из kz_gpk (со ссылками/формулировками)".
      2) На основании изложенного ПРОШУ СУД: 1) _____ 2) _____ → "конкретные требования истца, согласованные с фактурой situation и нормами из RAG".
      3) Перечень прилагаемых документов: 1) _____ ... → "список приложений по ГПК + фактические доказательства по situation".
      4) Дата: «__» __________ 20__ г. → "текущая дата в формате «DD» <месяц прописью> YYYY г."
      5) При формировании предварительного решения суда используй только коллекцию kz_civil_practice.

      ОГРАНИЧЕНИЕ ИСТОЧНИКОВ:
      - Используй ТОЛЬКО результаты search_legislation из коллекций kz_gk, kz_gpk, kz_civil_practice.
      - Никаких иных кодексов/законов, если они не пришли из этих коллекций.

      ДОКАЗАТЕЛЬСТВА И ПРИЛОЖЕНИЯ:
      - Не выдумывай конкретные документы, которых нет в описании ситуации.
      - Если доказательства не перечислены в situation — укажи типовые категории и пометь, что требуется уточнение:
        "<<НУЖНО УТОЧНИТЬ: договор/переписка/квитанции/акты/свидетельские показания (что есть фактически)>>"

      СТРУКТУРА (ЗАПОЛНИТЬ):
      ${template}
    `.trim();
  },
};

/**
 * Построитель универсальных промптов для всех 47 шаблонов
 */
export const PromptBuilder = {
  /**
   * Получить инструкции по роли
   */
  getRoleInstructions(roleId: number): string {
    return ROLE_INSTRUCTIONS[roleId] || ROLE_INSTRUCTIONS[1];
  },

  /**
   * Получить название стадии
   */
  getStageName(stageId: number): string {
    return STAGE_NAMES[stageId] || 'Неизвестная стадия';
  },

  /**
   * Построить RAG-стратегию для стадии
   */
  buildRAGStrategy(stageId: number, documentName: string): string {
    const strategy = STAGE_RAG_STRATEGIES[stageId] || STAGE_RAG_STRATEGIES[1];

    return `
      КРИТИЧЕСКОЕ ТРЕБОВАНИЕ (RAG):
      Используй ТОЛЬКО три коллекции в Qdrant и обязательно сделай поиск по каждой:
      1) ГК РК: collection="kz_gk" — ${strategy.kz_gk.focus}
      2) ГПК РК: collection="kz_gpk" — ${strategy.kz_gpk.focus}
      3) Судебное решение/практика: collection="kz_civil_practice" — ${strategy.kz_civil_practice.focus}

      RAG-ПРОЦЕДУРА (ОБЯЗАТЕЛЬНО):
      - Сделай поиски ТОЛЬКО через tool search_legislation (никаких иных источников).
      - Используй limit=5 для каждого запроса.
      - Выполни запросы:
        A) kz_gk: ${strategy.kz_gk.queries} запрос(а) — ${strategy.kz_gk.focus}
        B) kz_gpk: ${strategy.kz_gpk.queries} запрос(а) — ${strategy.kz_gpk.focus}
        C) kz_civil_practice: ${strategy.kz_civil_practice.queries} запрос(а) — ${strategy.kz_civil_practice.focus}
      - Формулируй запросы конкретно под документ "${documentName}" и описанную ситуацию.
      - Если в ходе написания явно не хватает нормы — разрешён +1 дополнительный запрос.
          `.trim();
  },

  /**
   * Построить инструкции по секциям
   */
  buildSectionsGuide(sections: IDocumentTemplate['sections']): string {
    if (!sections || sections.length === 0) {
      return '';
    }

    const guides = sections.map((section, index) => {
      const instruction =
        SECTION_INSTRUCTIONS[section.template] ||
        SECTION_INSTRUCTIONS[section.key] ||
        `${section.title_ru}: заполни согласно требованиям`;

      return `${index + 1}. ${section.title_ru.toUpperCase()}:\n${instruction}`;
    });

    return `
      СТРУКТУРА ДОКУМЕНТА (ЗАПОЛНИТЬ ВСЕ СЕКЦИИ):
      ${guides.join('\n\n')}
    `.trim();
  },

  /**
   * Построить универсальный промпт для любого шаблона
   */
  buildUniversalPrompt(
    template: IDocumentTemplate,
    situation: string,
    structureTemplate: string,
  ): string {
    const roleInstructions = this.getRoleInstructions(template.role_id);
    const stageName = this.getStageName(template.stage_id);
    const ragStrategy = this.buildRAGStrategy(
      template.stage_id,
      template.name_ru,
    );
    const sectionsGuide = this.buildSectionsGuide(template.sections);
    const specialRules = getSpecialRules(template.id, template.name_ru);
    const specialInstructions = buildSpecialInstructions(specialRules);

    // Определяем формат вывода
    let outputFormat = `
      ФОРМАТ ВЫВОДА:
      - Верни ТОЛЬКО готовый документ "${template.name_ru}".
      - Никаких пояснений, чеклистов, комментариев.
      - Не используй Markdown.
      - Официально-деловой стиль.`;

    if (specialRules.requiresCourtDecision) {
      outputFormat = `
        ФОРМАТ ВЫВОДА:
        - Верни 2 блока текста:
          БЛОК A: ${template.name_ru.toUpperCase()} — по структуре ниже.
          БЛОК B: ПРЕДВАРИТЕЛЬНОЕ РЕШЕНИЕ СУДА — отдельным разделом после основного документа.
        - Никаких пояснений, чеклистов, комментариев.
        - Не используй Markdown.
        - Официально-деловой стиль.`;
    }

    return `
      Ты — юрист-практик по Республике Казахстан.

      ДОКУМЕНТ: ${template.name_ru}
      СТАДИЯ ПРОЦЕССА: ${stageName}

      ${roleInstructions}

      ТВОЯ ЦЕЛЬ:
      Сформировать финальный документ "${template.name_ru}", который можно распечатать и подать в суд.

      ${ragStrategy}

      ${sectionsGuide}

      ${outputFormat}

      ЖЁСТКОЕ ПРАВИЛО ЗАПОЛНЕНИЯ:
      - В финальном тексте не должно остаться строк вида "_____", "__________", "__" (кроме строки "Подпись").
      - Любой прочерк замени на содержательный текст.
      - Если данных не хватает — пиши <<НУЖНО УТОЧНИТЬ: ...>>.

      ПРАВИЛО ССЫЛОК:
      - Если в результате search_legislation указан номер статьи — ссылайся: "в соответствии со ст. <номер> ГК РК / ГПК РК".
      - Если номера статьи нет — НЕ выдумывай: пиши <<НУЖНО УТОЧНИТЬ: статья>>.
      - Если релевантные фрагменты не найдены — ставь <<НУЖНО УТОЧНИТЬ: правовое основание>>.

      ОГРАНИЧЕНИЕ ИСТОЧНИКОВ:
      - Используй ТОЛЬКО результаты search_legislation из коллекций kz_gk, kz_gpk, kz_civil_practice.
      - Никаких иных кодексов/законов, если они не пришли из этих коллекций.

      ДОКАЗАТЕЛЬСТВА И ПРИЛОЖЕНИЯ:
      - Не выдумывай конкретные документы, которых нет в описании ситуации.
      - Если доказательства не перечислены — укажи типовые категории с пометкой <<НУЖНО УТОЧНИТЬ>>.
      ${specialInstructions}

      СИТУАЦИЯ КЛИЕНТА:
      ${situation}

      ШАБЛОН СТРУКТУРЫ (ЗАПОЛНИТЬ):
      ${structureTemplate}
    `.trim();
  },
};
