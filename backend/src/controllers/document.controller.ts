import { DocumentValidationService, DocumentService, logger } from '@services';
import { normalizeError } from '@helpers';
import { Request, Response } from 'express';
import { IGenerateDocumentRequest } from '@interfaces';
import { generateLegalDocument } from '../agents/legal_agent';

/**
 * Контроллер для работы с юридическими документами
 */
export const DocumentController = {
  /**
   * Генерация юридического документа
   * POST /api/documents/generate
   **/
  async generateDocument(req: Request, res: Response): Promise<void> {
    try {
      const {
        document_id,
        classification_id,
        role_id,
        stage_id,
        situation,
        court_name,
        court_address,
        case_number,
        price_of_claim,
        userData,
        opponentData,
      }: IGenerateDocumentRequest = req.body;

      await DocumentValidationService.validateDocument(
        document_id,
        classification_id,
        role_id,
        stage_id,
        situation,
        court_name,
        court_address,
        case_number,
        price_of_claim,
        userData,
        opponentData,
      );

      const structure = await DocumentService.prepareDocument(
        document_id,
        classification_id,
        role_id,
        stage_id,
        situation,
        court_name,
        court_address,
        case_number,
        price_of_claim,
        userData,
        opponentData,
      );

      if (!structure) {
        throw new Error('Document template not found');
      }

      // Ключевое: принудительно используем 3 загруженные коллекции, а не “генерацию шаблона”.
      // Агент сам сделает 3-way RAG через tool `search_legislation` с явным указанием коллекций.
      const prompt = `
        Ты — юрист-практик по Республике Казахстан.

        ТВОЯ ЦЕЛЬ:
        Сформировать финальный судебный документ, который можно распечатать и подать в суд, строго по структуре ниже. Так же к документу нужно отдельно добавить предварительное решение суда.

        КРИТИЧЕСКОЕ ТРЕБОВАНИЕ (RAG):
        Используй ТОЛЬКО три коллекции в Qdrant и обязательно сделай поиск по каждой:
        1) ГК РК: collection="kz_gk" — материально-правовые основания (права/обязанности сторон, основания требований).
        2) ГПК РК: collection="kz_gpk" — процессуальные требования: форма/содержание, подсудность/сроки/пошлина (если применимо), перечень приложений.
        3) Судебное решение/практика: collection="kz_civil_practice" — принципы формирования решения: оценка доказательств, мотивировка, резолютивная часть.

        RAG-ПРОЦЕДУРА (ОБЯЗАТЕЛЬНО, НО БЕЗ ЛИШНИХ ВЫЗОВОВ):
        - Сделай поиски ТОЛЬКО через tool search_legislation (никаких иных источников).
        - Используй limit=5 (инструмент всё равно ограничивает большие значения).
        - Выполни ровно такие вызовы:
          A) kz_gk: 2 запроса (материальные основания именно под ситуацию/предмет иска)
          B) kz_gpk: 2 запроса (форма/содержание иска + приложения/доказательства/пошлина/подсудность — что релевантно)
          C) kz_civil_practice: 2 запроса (мотивировка/оценка доказательств + резолютивная часть/структура решения)
        - Если в ходе написания явно не хватает нормы — разрешён +1 дополнительный запрос в нужную коллекцию, но не больше.
        - Затем пиши документ, вставляя найденные нормы ровно в нужные места каркаса.

        КАК ПИСАТЬ:
        - Официально-деловой стиль.
        - Там, где нужны статьи/пункты — ссылайся на найденные фрагменты (достаточно “в соответствии со ст. …”).
        - Не выдумывай нормы/номера статей: если номер статьи не найден — оставь <<НУЖНО УТОЧНИТЬ: статья/пункт>>.
        - Не добавляй “шаблон/пояснения”. Верни ТОЛЬКО готовый документ.

        ПРАВИЛО ССЫЛОК:
        - Если в результате search_legislation указан номер статьи (например “Статья 152” в тексте или “, 152” рядом с источником),
          ссылайся так: "в соответствии со ст. <номер> ГК РК" или "… ГПК РК" (в зависимости от коллекции).
        - Если номера статьи нет — НЕ выдумывай: пиши <<НУЖНО УТОЧНИТЬ: статья>> и опирайся на смысл найденного фрагмента.
        - Если релевантные фрагменты не найдены: НЕ выдумывай нормы — ставь <<НУЖНО УТОЧНИТЬ: правовое основание / статья>>.

        ФОРМАТ ВЫВОДА (ОБЯЗАТЕЛЬНО):
        - Верни ТОЛЬКО 2 блока текста в указанном порядке:
          БЛОК A: ИСКОВОЕ ЗАЯВЛЕНИЕ — строго по структуре ниже (заполни все прочерки).
          БЛОК B: ПРЕДВАРИТЕЛЬНОЕ РЕШЕНИЕ СУДА — отдельным разделом после иска.
        - Никаких пояснений, чеклистов, “как я думал”, ссылок на промпт/коллекции.
        - Не используй Markdown.

        ЖЁСТКОЕ ПРАВИЛО ЗАПОЛНЕНИЯ:
        - В финальном тексте не должно остаться строк вида "_____", "__________", "__" (кроме строки "Подпись").
        - Любой прочерк замени на содержательный текст. Если данных не хватает — пиши <<НУЖНО УТОЧНИТЬ: ...>>.

        Прочерки, которые нужно заменить на содержательный текст:
        1) Сведения о доказательствах:
          _____ → “перечень доказательств по ситуации + какие приложения приложить (по ГПК)”.
        2) Нормы права и процессуальные основания...: _____ → “материальные основания из kz_gk + процессуальные требования из kz_gpk (со ссылками/формулировками)”.
        3) На основании изложенного ПРОШУ СУД: 1) _____ 2) _____ → “конкретные требования истца, согласованные с фактурой situation и нормами из RAG”.
        4) Перечень прилагаемых документов: 1) _____ ... → “список приложений по ГПК + фактические доказательства по situation”.
        5) При формировании предварительного решения суда используй только коллекцию kz_civil_practice.
        6) Заполни текущую дату в формате «DD» <месяц прописью> YYYY г.

        ОГРАНИЧЕНИЕ ИСТОЧНИКОВ:
        - Используй ТОЛЬКО результаты search_legislation из коллекций kz_gk, kz_gpk, kz_civil_practice.
        - Никаких иных кодексов/законов, если они не пришли из этих коллекций.

        ДОКАЗАТЕЛЬСТВА И ПРИЛОЖЕНИЯ:
        - Не выдумывай конкретные документы, которых нет в описании ситуации.
        - Если доказательства не перечислены в situation — укажи типовые категории и пометь, что требуется уточнение:
          "<<НУЖНО УТОЧНИТЬ: договор/переписка/квитанции/акты/свидетельские показания (что есть фактически)>>"

        СТРУКТУРА (ЗАПОЛНИТЬ):
        ${structure}
      `.trim();

      const document = await generateLegalDocument(prompt);

      logger.info('Document generated successfully');

      res.json({
        success: true,
        document,
        metadata: {
          generatedAt: new Date().toISOString(),
          collections: ['kz_gk', 'kz_gpk', 'kz_civil_practice'],
        },
      });
    } catch (error: unknown) {
      const message = normalizeError(error);
      logger.error(`
        Failed to generate document
        Error: ${message}
      `);
      res.status(500).json({
        success: false,
        error: 'Ошибка при генерации документа',
        details: process.env.NODE_ENV === 'development' ? message : undefined,
      });
    }
  },
};
